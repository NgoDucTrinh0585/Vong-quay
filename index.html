<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gacha V√≤ng Quay T√πy Ch·ªânh</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Th∆∞ vi·ªán hi·ªáu ·ª©ng ph√°o hoa -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        .wheel-spin {
            transition: transform 4.5s cubic-bezier(0.2, 0.8, 0.1, 1);
        }
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }
        body {
            touch-action: manipulation;
        }
    </style>
</head>
<body class="bg-slate-900 overflow-x-hidden text-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // =============================================================
        // C·∫§U H√åNH √ÇM THANH T·∫†I ƒê√ÇY
        // M·ªói v√≤ng quay c√≥ √¢m thanh ri√™ng [spinning, fireworks, spinAgain]
        // =============================================================
        const SOUND_CONFIG = [
            { spinning: 'nhac_nen_tro_choi_vui_nhon_team_building_game_show-www_tiengdong_com.mp3', fireworks: 'Am_thanh_chuc_mung_chien_thang-www_tiengdong_com.mp3', spinAgain: 'nhac_nen_tro_choi_vui_nhon_team_building_game_show-www_tiengdong_com.mp3' },  // V√≤ng 1
            { spinning: 'nhac_doc_ve_cha_cha_cha-www_tiengdong_com.mp3', fireworks: 'Am_thanh_chuc_mung_chien_thang-www_tiengdong_com.mp3', spinAgain: 'nhac_doc_ve_cha_cha_cha-www_tiengdong_com.mp3' },  // V√≤ng 2
            { spinning: 'nhac_beat_lo_to_nhac_nen_keu_loto-www_tiengdong_com.mp3', fireworks: 'Am_thanh_chuc_mung_chien_thang-www_tiengdong_com.mp3', spinAgain: 'nhac_beat_lo_to_nhac_nen_keu_loto-www_tiengdong_com.mp3' }   // V√≤ng 3
        ];

        // --- ICONS ---
        const Icon = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Sparkles = ({className}) => <Icon className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></Icon>;
        const Ticket = ({className}) => <Icon className={className}><path d="M2 9V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v4a2 2 0 0 0 0 4v4a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-4a2 2 0 0 0 0-4Z"/><path d="M13 3v18"/><path d="M13 8h1"/><path d="M13 12h1"/><path d="M13 16h1"/></Icon>;
        const Flame = ({className}) => <Icon className={className}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></Icon>;
        const Play = ({className}) => <Icon className={className}><polygon points="5 3 19 12 5 21 5 3"/></Icon>;
        const Plus = ({className}) => <Icon className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Icon>;
        const Trash2 = ({className}) => <Icon className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;
        const Settings = ({className}) => <Icon className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const X = ({className}) => <Icon className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Icon>;
        const Check = ({className}) => <Icon className={className}><polyline points="20 6 9 17 4 12"/></Icon>;
        const Clipboard = ({className}) => <Icon className={className}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></Icon>;
        const AlertCircle = ({className}) => <Icon className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>;

        const WHEEL_COLORS_PALETTE = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#a855f7', '#ec4899'];
        const GRADIENT_OPTIONS = [
            { id: 'blue', label: 'Xanh d∆∞∆°ng', color: 'from-blue-500 to-cyan-400', border: 'border-blue-500/30' },
            { id: 'purple', label: 'T√≠m h·ªìng', color: 'from-purple-500 to-pink-500', border: 'border-purple-500/30' },
            { id: 'orange', label: 'V√†ng cam', color: 'from-yellow-400 to-orange-500', border: 'border-yellow-500/30' },
            { id: 'green', label: 'Xanh l√°', color: 'from-green-500 to-emerald-400', border: 'border-green-500/30' }
        ];

        // --- COMPONENT V√íNG QUAY (MODAL) ---
        function SpinWheelModal({ wheel, onClose, onRecordPrize, onFinish }) {
            const [rotation, setRotation] = useState(0);
            const [isSpinning, setIsSpinning] = useState(false);
            const [prize, setPrize] = useState(null);

            const spinSoundRef = useRef(null);
            const fireworksSoundRef = useRef(null);
            const spinAgainSoundRef = useRef(null);

            useEffect(() => {
                const soundIndex = wheel.id - 1;
                const soundConfig = SOUND_CONFIG[soundIndex] || SOUND_CONFIG[0];
                spinSoundRef.current = new Audio(soundConfig.spinning);
                fireworksSoundRef.current = new Audio(soundConfig.fireworks);
                spinAgainSoundRef.current = new Audio(soundConfig.spinAgain);
                
                return () => {
                    if (spinSoundRef.current) spinSoundRef.current.pause();
                    if (fireworksSoundRef.current) fireworksSoundRef.current.pause();
                    if (spinAgainSoundRef.current) spinAgainSoundRef.current.pause();
                };
            }, [wheel.id]);

            const items = wheel.items;
            const sliceAngle = 360 / items.length;

            const getConicGradient = () => {
                const parts = items.map((_, i) => {
                    const color = WHEEL_COLORS_PALETTE[i % WHEEL_COLORS_PALETTE.length];
                    const finalColor = (i === items.length - 1 && items.length % WHEEL_COLORS_PALETTE.length === 1) ? '#64748b' : color;
                    return `${finalColor} ${i * sliceAngle}deg ${(i + 1) * sliceAngle}deg`;
                });
                return `conic-gradient(${parts.join(', ')})`;
            };

            const fireConfetti = () => {
                const duration = 3 * 1000;
                const animationEnd = Date.now() + duration;
                const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 110 };

                const randomInRange = (min, max) => Math.random() * (max - min) + min;

                const interval = setInterval(function() {
                    const timeLeft = animationEnd - Date.now();

                    if (timeLeft <= 0) {
                        return clearInterval(interval);
                    }

                    const particleCount = 50 * (timeLeft / duration);
                    confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                    confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
                }, 250);
            };

            const startSpin = () => {
                if (isSpinning) return;
                
                // Ph√°t √¢m thanh quay
                if (spinSoundRef.current) {
                    spinSoundRef.current.currentTime = 0;
                    spinSoundRef.current.loop = true;
                    spinSoundRef.current.play().catch(e => console.log("Audio play failed", e));
                }
                
                setIsSpinning(true);
                const winnerIndex = Math.floor(Math.random() * items.length);
                const spins = 6; 
                const baseRotation = spins * 360;
                const targetSliceAngle = (winnerIndex * sliceAngle) + (sliceAngle / 2);
                const endRotation = baseRotation + (360 - targetSliceAngle);
                const randomOffset = (Math.random() - 0.5) * (sliceAngle * 0.6);
                const finalRotation = rotation + endRotation + randomOffset - (rotation % 360); 

                setRotation(finalRotation);
                
                setTimeout(() => {
                        setIsSpinning(false);
                        setPrize(items[winnerIndex]);

                        // D·ª´ng nh·∫°c quay, ph√°t ph√°o, sau ƒë√≥ ph√°t l·∫°i nh·∫°c
                        if (spinSoundRef.current) {
                            spinSoundRef.current.loop = false;
                            spinSoundRef.current.pause();
                            spinSoundRef.current.currentTime = 0;
                        }

                        // Ph√°t ti·∫øng ph√°o
                        if (fireworksSoundRef.current) {
                            fireworksSoundRef.current.currentTime = 0;
                            fireworksSoundRef.current.play().catch(e => console.log("Fireworks play failed", e));
                            
                            // Khi ph√°o k·∫øt th√∫c, ph√°t l·∫°i nh·∫°c
                            fireworksSoundRef.current.onended = () => {
                                if (spinAgainSoundRef.current) {
                                    spinAgainSoundRef.current.currentTime = 0;
                                    spinAgainSoundRef.current.loop = true;
                                    spinAgainSoundRef.current.play().catch(e => console.log("Spin again audio play failed", e));
                                }
                            };
                        }
                        fireConfetti();
                }, 4600);
            };

            const formatWheelText = (text) => {
                const match = text.match(/\[(.*?)\]/);
                if (match) return `[${match[1]}]`;
                return text.length > 10 ? text.substring(0, 10) + '..' : text;
            };

            const handleModalClose = () => {
                try {
                    if (spinSoundRef.current) {
                        spinSoundRef.current.loop = false;
                        spinSoundRef.current.pause();
                        spinSoundRef.current.currentTime = 0;
                    }
                    if (fireworksSoundRef.current) {
                        fireworksSoundRef.current.pause();
                        fireworksSoundRef.current.currentTime = 0;
                    }
                    if (spinAgainSoundRef.current) {
                        spinAgainSoundRef.current.loop = false;
                        spinAgainSoundRef.current.pause();
                        spinAgainSoundRef.current.currentTime = 0;
                    }
                } catch (e) {
                    console.log('Failed to stop audio on close:', e);
                }
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-slate-900/98 backdrop-blur-xl z-[100] flex flex-col items-center justify-center p-4">
                    <div className="absolute top-8 w-full text-center px-4">
                        <h2 className={`text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r ${wheel.color} uppercase tracking-widest drop-shadow-sm`}>
                            {wheel.name}
                        </h2>
                        <div className="flex items-center justify-center gap-2 text-slate-400 mt-2 font-bold">
                            <Ticket className="w-5 h-5 text-yellow-500" />
                            <span>Ph√≠: {wheel.cost} V√©</span>
                        </div>
                    </div>

                    {!isSpinning && !prize && (
                        <button onClick={handleModalClose} className="absolute top-6 right-6 text-slate-400 hover:text-white bg-slate-800/50 p-3 rounded-full transition-all">
                            <X className="w-6 h-6" />
                        </button>
                    )}

                    <div className="relative mt-8">
                        {/* Kim ch·ªâ */}
                        <div className="absolute -top-8 left-1/2 -translate-x-1/2 z-30 filter drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)]">
                            <div className="w-0 h-0 border-l-[18px] border-l-transparent border-r-[18px] border-r-transparent border-t-[35px] border-t-white"></div>
                            <div className="absolute -top-[2px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[15px] border-l-transparent border-r-[15px] border-r-transparent border-t-[30px] border-t-red-600"></div>
                        </div>

                        <div 
                            className="w-72 h-72 sm:w-[450px] sm:h-[450px] rounded-full border-[10px] border-slate-800 shadow-[0_0_80px_rgba(0,0,0,0.6)] wheel-spin relative overflow-hidden"
                            style={{ background: getConicGradient(), transform: `rotate(${rotation}deg)` }}
                        >
                            {items.map((item, i) => {
                                const angle = i * sliceAngle + (sliceAngle / 2);
                                return (
                                    <div key={i} className="absolute top-0 left-1/2 w-[2px] h-1/2 origin-bottom flex items-start justify-center" style={{ transform: `translateX(-50%) rotate(${angle}deg)` }}>
                                        <div className="mt-8 font-black text-white text-xs sm:text-base drop-shadow-[0_2px_4px_rgba(0,0,0,0.9)] whitespace-nowrap" style={{ transform: 'rotate(-90deg)' }}>
                                            {formatWheelText(item.text)}
                                        </div>
                                    </div>
                                );
                            })}
                            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-slate-900 rounded-full border-4 border-slate-700 shadow-2xl z-20 flex items-center justify-center">
                                <div className="w-4 h-4 bg-white rounded-full animate-pulse shadow-[0_0_10px_white]"></div>
                            </div>
                        </div>
                    </div>

                    <div className="mt-12 min-h-32 flex items-center justify-center w-full">
                        {!isSpinning && !prize ? (
                            <button onClick={startSpin} className={`px-16 py-5 rounded-full font-black text-3xl text-white bg-gradient-to-r ${wheel.color} hover:scale-110 active:scale-95 transition-all shadow-2xl shadow-current/40`}>
                                XOAY!
                            </button>
                        ) : prize ? (
                            <div className={`bg-slate-800/80 backdrop-blur border-2 rounded-[2rem] p-8 sm:p-10 text-center w-full max-w-xl mx-4 animate-in fade-in zoom-in duration-300 ${wheel.border}`}>
                                <h3 className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em] mb-4">CH√öC M·ª™NG B·∫†N ƒê√É TR√öNG</h3>
                                <div className={`text-xl sm:text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r ${wheel.color} mb-8 leading-relaxed px-4`}>
                                    {prize.text}
                                </div>
                                <button onClick={() => {
                                        try {
                                            if (spinSoundRef.current) {
                                                spinSoundRef.current.loop = false;
                                                spinSoundRef.current.pause();
                                                spinSoundRef.current.currentTime = 0;
                                            }
                                            if (fireworksSoundRef.current) {
                                                fireworksSoundRef.current.pause();
                                                fireworksSoundRef.current.currentTime = 0;
                                            }
                                            if (spinAgainSoundRef.current) {
                                                spinAgainSoundRef.current.loop = false;
                                                spinAgainSoundRef.current.pause();
                                                spinAgainSoundRef.current.currentTime = 0;
                                            }
                                        } catch (e) {
                                            console.log('Failed to stop sounds', e);
                                        }
                                        if (onRecordPrize && prize) {
                                            onRecordPrize(wheel.name, prize.text, wheel.cost, wheel.color);
                                        }
                                        onFinish(); onClose();
                                    }} className="w-full max-w-[240px] mx-auto py-4 rounded-xl font-black text-base text-white bg-slate-700 hover:bg-slate-600 transition-all active:scale-95 shadow-lg">
                                    NH·∫¨N & TI·∫æP T·ª§C
                                </button>
                            </div>
                        ) : (
                            <div className="text-2xl font-black text-white italic animate-pulse tracking-widest flex items-center gap-3">
                                <Sparkles className="animate-spin text-yellow-500" /> ƒêANG QUAY...
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- COMPONENT CH√çNH ---
        function App() {
            const [tickets, setTickets] = useState(() => {
                const saved = localStorage.getItem('gacha_tickets');
                return saved ? parseInt(saved) : 10;
            });
            const [addAmount, setAddAmount] = useState('1');
            const [showSettings, setShowSettings] = useState(false);
            const [activeWheel, setActiveWheel] = useState(null);
            const [errorMsg, setErrorMsg] = useState('');
            
            const [editingItemId, setEditingItemId] = useState(null);
            const [editingText, setEditingText] = useState('');
            
            const [bulkPasteId, setBulkPasteId] = useState(null);
            const [bulkText, setBulkText] = useState('');
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [showClearHistoryConfirm, setShowClearHistoryConfirm] = useState(false);
            
            const [spinHistory, setSpinHistory] = useState(() => {
                const saved = localStorage.getItem('gacha_spin_history');
                return saved ? JSON.parse(saved) : [];
            });

            const [wheels, setWheels] = useState(() => {
                const saved = localStorage.getItem('gacha_wheels_config');
                try {
                    return saved ? JSON.parse(saved) : [
                        { id: 1, name: 'V√≤ng Kh·ªüi ƒê·ªông', cost: 1, color: 'from-blue-500 to-cyan-400', border: 'border-blue-500/30', items: [{ id: '1-1', text: '[SR] Ngh·ªâ 10p' }, { id: '1-2', text: '[R] 20 H√≠t ƒë·∫•t' }, { id: '1-3', text: '[N] H·ªçc ti·∫øp' }] },
                        { id: 2, name: 'V√≤ng Ti√™u Chu·∫©n', cost: 4, color: 'from-purple-500 to-pink-500', border: 'border-purple-500/30', items: [{ id: '2-1', text: '[SSR] Xem 1 t·∫≠p phim' }, { id: '2-2', text: '[SR] Ch∆°i 1 v√°n game' }] },
                        { id: 3, name: 'V√≤ng Th·∫ßn Tho·∫°i', cost: 8, color: 'from-yellow-400 to-orange-500', border: 'border-yellow-500/30', items: [{ id: '3-1', text: '[LEGEND] Ngh·ªâ lu√¥n t·ªëi nay' }] }
                    ];
                } catch (e) {
                    console.log('Failed to parse wheels config:', e);
                    return [
                        { id: 1, name: 'V√≤ng Kh·ªüi ƒê·ªông', cost: 1, color: 'from-blue-500 to-cyan-400', border: 'border-blue-500/30', items: [{ id: '1-1', text: '[SR] Ngh·ªâ 10p' }, { id: '1-2', text: '[R] 20 H√≠t ƒë·∫•t' }, { id: '1-3', text: '[N] H·ªçc ti·∫øp' }] },
                        { id: 2, name: 'V√≤ng Ti√™u Chu·∫©n', cost: 4, color: 'from-purple-500 to-pink-500', border: 'border-purple-500/30', items: [{ id: '2-1', text: '[SSR] Xem 1 t·∫≠p phim' }, { id: '2-2', text: '[SR] Ch∆°i 1 v√°n game' }] },
                        { id: 3, name: 'V√≤ng Th·∫ßn Tho·∫°i', cost: 8, color: 'from-yellow-400 to-orange-500', border: 'border-yellow-500/30', items: [{ id: '3-1', text: '[LEGEND] Ngh·ªâ lu√¥n t·ªëi nay' }] }
                    ];
                }
            });

            const [newItems, setNewItems] = useState({ 1: '', 2: '', 3: '' });

            useEffect(() => {
                localStorage.setItem('gacha_tickets', tickets.toString());
                localStorage.setItem('gacha_wheels_config', JSON.stringify(wheels));
                localStorage.setItem('gacha_spin_history', JSON.stringify(spinHistory));
            }, [tickets, wheels, spinHistory]);

            const handleAddTickets = () => {
                const amt = parseInt(addAmount);
                if (amt > 0) {
                    setTickets(t => t + amt);
                    setAddAmount('1');
                }
            };

            const handleUpdateWheelConfig = (id, field, value) => {
                setWheels(prev => prev.map(w => {
                    if (w.id === id) {
                        const updated = { ...w, [field]: value };
                        if (field === 'color') {
                            const opt = GRADIENT_OPTIONS.find(o => o.color === value);
                            updated.border = opt ? opt.border : 'border-slate-700';
                        }
                        return updated;
                    }
                    return w;
                }));
            };

            const handleAddItem = (wId) => {
                if (!newItems[wId].trim()) return;
                setWheels(prev => prev.map(w => w.id === wId ? { ...w, items: [{ id: Date.now().toString() + Math.random(), text: newItems[wId] }, ...w.items] } : w));
                setNewItems({ ...newItems, [wId]: '' });
            };

            const handleRemoveItem = (wId, iId) => {
                setWheels(prev => prev.map(w => w.id === wId ? { ...w, items: w.items.filter(i => i.id !== iId) } : w));
            };

            const saveEdit = (wId) => {
                if (!editingText.trim()) return;
                setWheels(prev => prev.map(w => {
                    if (w.id === wId) {
                        return { ...w, items: w.items.map(item => item.id === editingItemId ? { ...item, text: editingText } : item) };
                    }
                    return w;
                }));
                setEditingItemId(null);
            };

            const handleBulkUpdate = () => {
                if (!bulkText.trim()) { setBulkPasteId(null); return; }
                const lines = bulkText.split('\n').map(l => l.trim()).filter(l => l !== '');
                const newItemsList = lines.map(l => ({ id: Date.now().toString() + Math.random(), text: l }));
                setWheels(prev => prev.map(w => w.id === bulkPasteId ? { ...w, items: newItemsList } : w));
                setBulkPasteId(null);
                setBulkText('');
            };

            const performReset = () => {
                setTickets(0);
                setShowResetConfirm(false);
            };

            const addToHistory = (wheelName, prize, cost, wheelColor) => {
                const now = new Date();
                const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                const newEntry = {
                    id: Date.now().toString(),
                    wheelName,
                    prize,
                    cost,
                    wheelColor,
                    time: timeStr,
                    timestamp: now.getTime()
                };
                setSpinHistory(prev => [newEntry, ...prev].slice(0, 10));
            };

            const getRelativeDate = (timestamp) => {
                // X·ª≠ l√Ω d·ªØ li·ªáu c≈© kh√¥ng c√≥ timestamp
                if (!timestamp) return '';
                
                const recordDate = new Date(timestamp);
                
                // Ki·ªÉm tra ng√†y h·ª£p l·ªá
                if (isNaN(recordDate.getTime())) return '';
                
                const today = new Date();
                const targetDate = new Date(recordDate);
                
                // ƒê∆∞a c·∫£ 2 m·ªëc th·ªùi gian v·ªÅ 00:00:00 c·ªßa ng√†y ƒë√≥ ƒë·ªÉ so s√°nh ch√≠nh x√°c s·ªë ng√†y
                today.setHours(0, 0, 0, 0);
                targetDate.setHours(0, 0, 0, 0);
                
                const diffTime = today.getTime() - targetDate.getTime();
                const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    return 'H√¥m nay';
                } else if (diffDays === 1) {
                    return 'H√¥m qua';
                } else {
                    const day = String(recordDate.getDate()).padStart(2, '0');
                    const month = String(recordDate.getMonth() + 1).padStart(2, '0');
                    return `${day}/${month}`;
                }
            };

            const deleteFromHistory = (id) => {
                setSpinHistory(prev => prev.filter(item => item.id !== id));
            };

            const clearHistory = () => {
                setShowClearHistoryConfirm(true);
            };

            const confirmClearHistory = () => {
                setSpinHistory([]);
                setShowClearHistoryConfirm(false);
            };

            const getColorClassesFromWheel = (wheelColor) => {
                if (!wheelColor) {
                    return { text: 'text-emerald-300', border: 'border-l-emerald-500', bag: 'from-emerald-500 to-emerald-600' };
                }
                if (wheelColor.includes('blue') && wheelColor.includes('cyan')) {
                    return { text: 'text-cyan-400', border: 'border-l-cyan-500', bag: 'from-blue-500 to-cyan-400' };
                } else if (wheelColor.includes('purple') && wheelColor.includes('pink')) {
                    return { text: 'text-pink-500', border: 'border-l-pink-500', bag: 'from-purple-500 to-pink-500' };
                } else if (wheelColor.includes('yellow') || wheelColor.includes('orange')) {
                    return { text: 'text-orange-500', border: 'border-l-orange-500', bag: 'from-yellow-400 to-orange-500' };
                }
                return { text: 'text-emerald-300', border: 'border-l-emerald-500', bag: 'from-emerald-500 to-emerald-600' };
            };

            const openWheel = (w) => {
                if (tickets < w.cost) {
                    setErrorMsg(`B·∫°n kh√¥ng ƒë·ªß V√©! C·∫ßn th√™m ${w.cost - tickets} V√© n·ªØa.`);
                    setTimeout(() => setErrorMsg(''), 3000);
                    return;
                }
                if (w.items.length < 2) {
                    setErrorMsg('V√≤ng quay c·∫ßn √≠t nh·∫•t 2 ph·∫ßn th∆∞·ªüng ƒë·ªÉ ho·∫°t ƒë·ªông.');
                    setTimeout(() => setErrorMsg(''), 3000);
                    return;
                }
                setActiveWheel(w);
            };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-6xl mx-auto">
                    {/* Header */}
                    <div className="flex flex-col md:flex-row items-center justify-between gap-6 bg-slate-800/50 p-6 rounded-[2rem] border border-slate-700 shadow-2xl mb-8">
                        <div className="flex items-center gap-4">
                            <div className="bg-gradient-to-br from-blue-500 to-cyan-400 p-3 rounded-2xl shadow-lg shadow-blue-500/20">
                                <Sparkles className="w-8 h-8 text-white" />
                            </div>
                            <div>
                                <h1 className="text-3xl font-black text-white tracking-tight">GACHA K·ª∂ LU·∫¨T</h1>
                                <p className="text-slate-400 text-sm font-medium">Bi·∫øn k·ª∑ lu·∫≠t th√†nh ni·ªÅm vui</p>
                            </div>
                        </div>

                        <div className="flex flex-wrap items-center justify-center gap-4">
                            <div className="bg-slate-900/80 px-6 py-3 rounded-2xl border border-slate-700 flex items-center gap-4 shadow-inner">
                                <Ticket className="w-8 h-8 text-yellow-500 drop-shadow-[0_0_8px_rgba(234,179,8,0.4)]" />
                                <div className="flex flex-col justify-center text-center">
                                    <span className="text-[10px] font-bold text-slate-500 uppercase">S·ªë V√© Hi·ªán C√≥</span>
                                    <span className="text-3xl font-black text-yellow-500 tabular-nums leading-none">{tickets}</span>
                                </div>
                            </div>

                            <div className="flex gap-2">
                                <div className="flex bg-slate-900 rounded-xl overflow-hidden border border-slate-700">
                                    <input type="number" value={addAmount} onChange={e => setAddAmount(e.target.value)} className="w-16 bg-transparent px-3 py-2 text-center font-bold focus:outline-none" />
                                    <button onClick={handleAddTickets} className="bg-blue-600 hover:bg-blue-500 px-4 font-bold transition-all active:scale-95 text-white">NH·∫¨N</button>
                                </div>
                                <button onClick={() => setShowSettings(!showSettings)} className={`p-3 rounded-xl border transition-all ${showSettings ? 'bg-white text-slate-900 border-white' : 'bg-slate-800 text-slate-400 border-slate-700 hover:text-white'}`}>
                                    <Settings className="w-6 h-6" />
                                </button>
                                <button onClick={() => setShowResetConfirm(true)} className="bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 px-4 py-3 rounded-2xl border-2 border-red-400 shadow-lg shadow-red-500/30 transition-all flex items-center gap-2 text-white font-bold text-sm hover:scale-105 active:scale-95">
                                    <Flame className="w-5 h-5" /> Ph·∫°m Lu·∫≠t
                                </button>
                            </div>
                        </div>
                    </div>

                    {errorMsg && <div className="bg-red-500/20 border border-red-500 text-red-200 p-4 rounded-2xl text-center mb-6 font-bold animate-pulse">{errorMsg}</div>}

                    {/* Settings UI */}
                    {showSettings && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 animate-in slide-in-from-top duration-300">
                            {wheels.map(w => (
                                <div key={w.id} className="bg-slate-800 p-5 rounded-3xl border border-slate-700 space-y-4 shadow-lg">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h3 className="font-black text-xs text-slate-500 uppercase tracking-widest flex items-center gap-2">
                                                <div className={`w-2 h-2 rounded-full bg-gradient-to-r ${w.color}`}></div>
                                                V√≤ng {w.id}
                                            </h3>
                                            <p className="text-[10px] text-slate-400 mt-1">{w.items.length} ph·∫ßn th∆∞·ªüng</p>
                                        </div>
                                        <button onClick={() => { setBulkPasteId(w.id); setBulkText(w.items.map(i => i.text).join('\n')); }} className="text-[10px] font-bold bg-slate-700 hover:bg-slate-600 text-slate-300 px-2 py-1 rounded-md transition-colors flex items-center gap-1">
                                            <Clipboard className="w-3 h-3" /> D√°n nhanh
                                        </button>
                                    </div>
                                    <div className="space-y-3 text-xs">
                                        <input type="text" value={w.name} onChange={e => handleUpdateWheelConfig(w.id, 'name', e.target.value)} className="w-full bg-slate-900 rounded-lg px-3 py-2 focus:ring-1 focus:ring-blue-500 outline-none" placeholder="T√™n v√≤ng quay" />
                                        <div className="flex items-center gap-2 bg-slate-900 rounded-lg px-3">
                                            <span className="text-slate-500 font-bold uppercase text-[9px]">Gi√°:</span>
                                            <input type="number" value={w.cost} onChange={e => handleUpdateWheelConfig(w.id, 'cost', parseInt(e.target.value) || 0)} className="flex-1 bg-transparent py-2 outline-none" />
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Wheels List */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        {wheels.map(w => (
                            <div key={w.id} className={`bg-slate-800/40 backdrop-blur-sm rounded-[2.5rem] border-2 ${w.border} overflow-hidden flex flex-col shadow-xl`}>
                                <div className={`p-8 bg-gradient-to-br ${w.color} relative`}>
                                    <div className="absolute top-4 right-6 opacity-20"><Ticket className="w-16 h-16 text-white" /></div>
                                    <h2 className="text-2xl font-black text-white leading-tight mb-1 drop-shadow-md">{w.name}</h2>
                                    <div className="flex items-center justify-between">
                                        <p className="text-white/80 font-bold text-sm uppercase tracking-wider">{w.cost} V√© / L·∫ßn</p>
                                        <span className="text-white/70 font-bold text-xs bg-white/10 px-3 py-1 rounded-full">({w.items.length})</span>
                                    </div>
                                </div>

                                <div className="p-6 flex flex-col flex-1 gap-6">
                                    <button onClick={() => openWheel(w)} className={`w-full py-4 rounded-2xl font-black text-lg shadow-lg transition-all active:scale-95 flex items-center justify-center gap-3 ${tickets >= w.cost ? `bg-white text-slate-900 hover:bg-slate-100` : 'bg-slate-700 text-slate-500 cursor-not-allowed opacity-50'}`}>
                                        <Play className="w-6 h-6 fill-current" /> B·∫ÆT ƒê·∫¶U QUAY
                                    </button>

                                    <div className="space-y-4">
                                        <div className="flex gap-2">
                                            <input type="text" placeholder="Th√™m ph·∫ßn th∆∞·ªüng..." value={newItems[w.id]} onChange={e => setNewItems({...newItems, [w.id]: e.target.value})} onKeyDown={e => e.key === 'Enter' && handleAddItem(w.id)} className="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-4 py-2 text-sm focus:outline-none focus:border-blue-500" />
                                            <button onClick={() => handleAddItem(w.id)} className="bg-slate-700 hover:bg-slate-600 p-2 rounded-xl text-white"><Plus className="w-5 h-5" /></button>
                                        </div>

                                        <div className="max-h-[300px] overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                                            {w.items.map(item => (
                                                <div key={item.id} className="group bg-slate-900/50 hover:bg-slate-900 p-3 rounded-xl border border-slate-800 flex justify-between items-center gap-2 transition-all">
                                                    {editingItemId === item.id ? (
                                                        <div className="flex items-center gap-2 w-full">
                                                            <input autoFocus type="text" value={editingText} onChange={e => setEditingText(e.target.value)} onKeyDown={e => e.key === 'Enter' ? saveEdit(w.id) : e.key === 'Escape' ? setEditingItemId(null) : null} className="flex-1 bg-slate-800 border border-blue-500 rounded-lg px-2 py-1 text-sm outline-none text-white" />
                                                            <button onClick={() => saveEdit(w.id)} className="text-green-500"><Check className="w-4 h-4" /></button>
                                                        </div>
                                                    ) : (
                                                        <>
                                                            <span onClick={() => { setEditingItemId(item.id); setEditingText(item.text); }} className="text-sm font-medium text-slate-300 truncate cursor-pointer hover:text-white flex-1">{item.text}</span>
                                                            <button onClick={() => handleRemoveItem(w.id, item.id)} className="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all"><Trash2 className="w-4 h-4" /></button>
                                                        </>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* MODAL: RESET CONFIRMATION */}
                    {showResetConfirm && (
                        <div className="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-[200] flex items-center justify-center p-4">
                            <div className="bg-slate-800 border border-slate-700 w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-in zoom-in-95">
                                <div className="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <AlertCircle className="w-8 h-8 text-red-500" />
                                </div>
                                <h3 className="text-xl font-black text-white text-center mb-2">X√ÅC NH·∫¨N RESET?</h3>
                                <p className="text-slate-400 text-center text-sm mb-6">H√†nh ƒë·ªông n√†y s·∫Ω x√≥a to√†n b·ªô s·ªë V√© hi·ªán c√≥ v·ªÅ 0. B·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowResetConfirm(false)} className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-white transition-all">H·ª¶Y</button>
                                    <button onClick={performReset} className="flex-1 py-3 bg-red-600 hover:bg-red-500 rounded-xl font-black text-white transition-all shadow-lg shadow-red-500/20">RESET NGAY</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL: BULK PASTE */}
                    {bulkPasteId && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[110] flex items-center justify-center p-4">
                            <div className="bg-slate-800 border border-slate-700 w-full max-w-xl rounded-[2rem] p-8 shadow-2xl flex flex-col gap-6 animate-in zoom-in-95">
                                <div>
                                    <h3 className="text-2xl font-black text-white uppercase italic">D√°n danh s√°ch ph·∫ßn th∆∞·ªüng</h3>
                                    <p className="text-slate-400 text-sm mt-1">M·ªói d√≤ng vƒÉn b·∫£n b√™n d∆∞·ªõi s·∫Ω tr·ªü th√†nh m·ªôt gi·∫£i th∆∞·ªüng m·ªõi.</p>
                                </div>
                                <textarea autoFocus placeholder="V√≠ d·ª•:&#10;Gi·∫£i 1&#10;Gi·∫£i 2..." value={bulkText} onChange={e => setBulkText(e.target.value)} className="w-full h-64 bg-slate-900 border border-slate-700 rounded-2xl p-4 text-slate-200 focus:outline-none focus:border-blue-500 font-mono text-sm resize-none custom-scrollbar" />
                                <div className="flex gap-3">
                                    <button onClick={() => setBulkPasteId(null)} className="flex-1 py-4 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-white transition-all">H·ª¶Y</button>
                                    <button onClick={handleBulkUpdate} className="flex-[2] py-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-black text-white transition-all shadow-lg">L∆ØU DANH S√ÅCH</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {spinHistory.length > 0 && (
                        <div className="mt-12 bg-slate-800/40 backdrop-blur-sm rounded-[2.5rem] border border-emerald-500/30 p-8 shadow-xl">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-2xl font-black text-emerald-300">üìã L·ªäCH S·ª¨ QUAY G·∫¶N ƒê√ÇY</h3>
                                <button onClick={clearHistory} className="px-4 py-2 bg-red-600/30 hover:bg-red-600/50 border-2 border-red-500 rounded-lg font-bold text-red-300 text-sm transition-all shadow-lg shadow-red-500/10">
                                    üóëÔ∏è X√ìA L·ªäCH S·ª¨
                                </button>
                            </div>
                            <div className="space-y-3">
                                {spinHistory.map((record) => {
                                    const colors = getColorClassesFromWheel(record.wheelColor);
                                    const deleteButtonColor = colors.text === 'text-cyan-400' ? 'hover:text-cyan-400' : 
                                                             colors.text === 'text-pink-500' ? 'hover:text-pink-500' : 
                                                             colors.text === 'text-orange-500' ? 'hover:text-orange-500' : 
                                                             'hover:text-emerald-300';
                                    const relativeDate = getRelativeDate(record.timestamp);
                                    return (
                                    <div key={record.id} className={`bg-slate-900/60 border-l-4 p-4 hover:shadow-lg transition-all flex items-center justify-between gap-6 rounded-lg group ${colors.border}`}>
                                        <div className="flex items-center gap-4 flex-1">
                                            <p className={`text-xs font-black text-white px-3 py-1 rounded-lg min-w-fit bg-gradient-to-r ${colors.bag}`}>
                                                {relativeDate ? `${relativeDate} - ${record.time}` : record.time}
                                            </p>
                                            <div className="flex-1">
                                                <p className="text-xs font-bold text-slate-400 mb-1">{record.wheelName}</p>
                                                <p className={`font-black text-sm ${colors.text}`}>{record.prize}</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <p className="text-sm font-bold text-amber-400 min-w-fit">-{record.cost} v√©</p>
                                            <button onClick={() => deleteFromHistory(record.id)} className={`text-slate-500 ${deleteButtonColor} opacity-0 group-hover:opacity-100 transition-all`}>
                                                <X className="w-5 h-5" />
                                            </button>
                                        </div>
                                    </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {showClearHistoryConfirm && (
                        <div className="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-[200] flex items-center justify-center p-4">
                            <div className="bg-slate-800 border border-slate-700 w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-in zoom-in-95">
                                <div className="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <AlertCircle className="w-8 h-8 text-red-500" />
                                </div>
                                <h3 className="text-xl font-black text-white text-center mb-2">X√ÅC NH·∫¨N X√ìA?</h3>
                                <p className="text-slate-400 text-center text-sm mb-6">H√†nh ƒë·ªông n√†y s·∫Ω x√≥a to√†n b·ªô l·ªãch s·ª≠ quay. B·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowClearHistoryConfirm(false)} className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-white transition-all">H·ª¶Y</button>
                                    <button onClick={confirmClearHistory} className="flex-1 py-3 bg-red-600 hover:bg-red-500 rounded-xl font-black text-white transition-all shadow-lg shadow-red-500/20">X√ìA NGAY</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeWheel && (
                        <SpinWheelModal 
                            wheel={activeWheel} 
                            onClose={() => setActiveWheel(null)} 
                            onRecordPrize={(wheelName, prize, cost, wheelColor) => {
                                addToHistory(wheelName, prize, cost, wheelColor);
                                setTickets(t => t - cost);
                            }}
                            onFinish={() => setActiveWheel(null)}
                        />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
